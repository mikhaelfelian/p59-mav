name: 🚀 Deploy and Notify

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH Connection
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy Code to Server
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}

            echo "🔁 Updating repository..."
            if [ -d .git ]; then
              git fetch --all --prune
              git checkout main || true
              git reset --hard origin/main
              git clean -fd
            else
              git clone -b main git@github.com:${{ github.repository }} .
            fi

            echo "⚙️ Adjusting permissions..."
            chown -R $USER:$USER .
            chmod -R u+rwX .

            echo "✅ Deployment complete."
          EOF

      - name: Notify Deployment Completion to GitHub Issue
        env:
          GITHUB_TOKEN: ${{ secrets.TOKENS }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          echo "📝 Creating issue comment..."
          response=$(curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"body\": \"✅ **Deploy Sukses ke Server**\\n- **Branch:** main\\n- **Commit:** $SHA\\n- **Link:** [Lihat Aplikasi](${{
              secrets.APP_URL
            }})\"}" \
            https://api.github.com/repos/$REPO/issues/1/comments)

          echo "💬 API Response: $response"
